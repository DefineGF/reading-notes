#### 中断分类

##### 内中断：异常；例外；陷入；（与当前执行指令有关）

- 自愿中断：指令中断；系统调用时使用访管指令（又叫陷入指令，trap指令）
- 强迫中断
    - 硬件故障：缺页等（不是硬件中断）
    - 软件中断：整数除0等

程序的非法操作码；算术溢出；虚拟内存缺页；专门陷入指令；等

又可分为：

- 故障：潜在可恢复错误；可能返回当前指令；
- 陷阱：有意的异常；总是下一条指令；
- 终止：不可恢复；杀死进程；



##### 外中断

与当前运行指令无关；

- 外设请求：IO操作完成发出信号量；
- 人工干预：用户终止进程；



##### 硬件中断（属于外中断）

通过外部的已经产生的中断；

- 非屏蔽中断：通过不可屏蔽中断请求NMI控制；

    不受IF中断标志位影响；

- 可屏蔽中断：通过请求标志触发器 INTR 控制；受IF影响；



##### 软件中断

通过某条指令产生的中断；



##### 中断 & 异常 & 系统调用

系统调用：

用户程序中与资源相关的操作，如存储器分配，进行IO传输，文件管理等，都必须通过操作系统代为完成；

- 设备管理
- 文件管理
- 进程控制/通信
- 内存管理



#### 其他

##### 指令执行之中断细节

1. CU 将 SP 减一：SP -> MAR -> 地址总线 -> 主存
2. CU 发出写命令 -> 控制总线 -> 主存
3. PC -> MDR -> 数据总线 -> 主存

解析一：

传统栈：初始 top = -1，栈顶指针指向栈顶元素；

- 进栈：top++，push
- 出栈：pop，top--；

程序栈：存放在内存中的某个区域，sp保存栈顶元素的地址；

- 进栈：top--，push
- 出栈：pop，sp++；

而后将要存放的位置地址 （sp）到 内存；



解析二：

保存断点的实质是保存当前 PC 值；



##### 中断向量

每个中断服务程序都有一个入口地址；系统全部中断向量存放到存储器的一个区域，称之为中断向量表；

即中断服务程序入口地址表；



##### 中断判优

可由硬件或者软件实现；

- 硬件故障属于最高级，其次是软件中断；

- 非屏蔽中断 > 可屏蔽中断；

- DMA请求 > IO设备传送中断请求；

- 高速 > 低速；

- 输入 > 输出

中断响应优先级：由硬件排队线路或者和中断查询程序决定；

中断处理优先级：由中断屏蔽字决定；



### 中断隐指令

并不是指令系统中的一条真正指令，无操作码；

##### 执行过程

1. 关中断

    为了保护中断现场期间不被新的中断打断；

2. 保存断点

    为正确返回到原来的程序，将断点（PC值）保存起来；

    可以压入堆栈，也可以存入主存的特定单元；

3. 取出中断向量传送至PC

    - 硬件向量法：硬件产生中断类型号，中断类型号指出中断向量的存放地址；
    - 软件查询法：软件编程方法；

    

#### 具体细节

1. 关中断
2. 保存断点
3. 中断服务程序寻址
4. 保护现场和屏蔽字
5. 开中断
6. 执行中断服务程序
7. 关中断
8. 恢复现场和屏蔽字
9. 开中断
10. 中断返回

硬件完成：1， 2，3

中断程序：4 -> 10；

5：允许更高优先级的中断；

10：中断返回使其返回到原程序断点（核心态 -> 用户态）

##### 现场和屏蔽字

现场信息：程序状态字；中断屏蔽字；CPU一些寄存器的信息；

每个中断源都有一个屏蔽触发器，1 表示屏蔽该中断；0 表示 可正常申请；

屏蔽器内容称为屏蔽字；



