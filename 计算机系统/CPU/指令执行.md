#### CPU 执行指令 （CISC）

##### 取指： MAR -> 地址总线  -> MEM -> 数据总线 -> MDR

PC -> Bus -> MAR （内部总线）

1 -> R (读)

MEM（MAR） -> MDR；

MDR -> Bus -> IR

##### 译码（取数）

- IR
    - 操作码 -> 解码器 (指令译码器) -> 控制单元 -> 取数信号
    - 地址码 -> MAR -> MEM -> MDR

##### 执行

- 加减：

    1. 被减数 -> ACC (累加器)
    2. MDR -> 寄存器
    3. A ALU B    -> ACC (暂存在ALU运算结果)

- 乘除：MQ寄存器 (乘商寄存器)

    1. 被乘 -> ACC  -> 置于 AX/DX 中；
    2. 乘数 -> MQ
    3. A ALU B : 高位-> ACC ; 低位 -> MQ

- 回写

    ACC -> MDR -> 内存



#### CPU 五段 RISC 流水

（访存只有load 和 store 指令）

##### 取指周期 IF



##### 指令译码 / 读寄存器器 （ID）

译码 & 访问通用寄存器得到所需操作数；



##### 执行 / 计算有效地址 周期（EX）

- load / store 指令：ALU计算访存有效的地址；
- 寄存器 op 寄存器；寄存器 op 操作数；
- 分支指令：偏移量 + PC



##### 存储器访问  / 分支跳转  周期（MEM）（只有 load/store 和 分支指令）

其他指令在此周期不做任何操作；

- load / store ： 根据有效地址 读写数据；
- 分支：转移目标地址 -> PC



##### 写回周期（WB）

将结果写入通用寄存器（不是存储器哦，MEM周期执行写入内存操作）

ALU：数据 自 ACC -> reg

load：存储器 -> reg



#### 流水线因素

##### 资源冲突

- 前一指令访存时，后一指令 暂停一时钟周期；
- 单独设置数据存储器 & 指令存储器



##### 相关

- 数据相关

    - RAW
    - WAR
    - WAW

    按序发射，按序完成时，只可能出现 RAW 相关：

    ```
    W:IF ID	EX	MEM WB
    R:	 IF	ID	EX	MEM	WB
    ```

    第一条写操作在 MEM 周期完成；第二条取寄存器操作在 ID 阶段完成；

    解决：

    - 相关指令及后序暂停一个或者几个时钟周期，知道相关问题消失再继续；
        - 硬件阻塞
        - 软件插入 NOP 指令
    - 设置专用通道（无需写回，直接作为相关指令的输入数据）
    - 通过编译器对数据相关的指令进行优化

- 控制相关

    - 分支预测：尽早生成转移目标地址；
        - 静态预测；
        - 动态预测；
    - 同时预测成功和不成功
    - 加快和提前形成条件码
    - 提高转移方向的成功率

