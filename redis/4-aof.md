### AOF

- 命令执行后才记录日志，不会阻塞当前写操作；
- AOF 文件是以追加的方式，逐一记录接收到的写命令的；



##### 内容

```bash
*3   # 表示有3部分组成
$3   # 表示有3个字节
set
$7
testkey
$9
testvalue
```



##### 写回策略

- **Always**，同步写回：每个写命令执行完，立马同步地将日志写回磁盘；

- **Everysec**，每秒写回：每个写命令执行完，只是先把日志写到 AOF 文件的内存缓冲区，每隔一秒把缓冲区中的内容写入磁盘；

- **No**，操作系统控制的写回：每个写命令执行完，只是先把日志写到 AOF 文件的内存缓冲区，由操作系统决定何时将缓冲区内容写回磁盘



#### aof 重写

- AOF 重写机制就是在**重写**时，Redis 根据数据库的现状创建一个新的 AOF 文件，也就是说，**读取数据库中的所有键值对**，然后对每一个键值对用一条命令记录它的写入。比如说，当读取了键值对“testkey”: “testvalue”之后，重写机制会记录 set testkey testvalue 这条命令。这样，当需要恢复时，可以重新执行该命令，实现“testkey”: “testvalue”的写入；
- 和 AOF 日志由**主线程**写回不同，重写过程是由后台子进程 **bgrewriteaof** 完成的，为了避免阻塞主线程；

过程：

1. 每次执行**重写**时，主线程 fork 出后台的 bgrewriteaof 子进程；fork 会把主线程的内存拷贝一份给 bgrewriteaof 子进程，这里面就包含了数据库的最新数据
2. bgrewriteaof 子进程逐一把拷贝的数据写成操作，记入重写日志；



##### AOF 日志

因为主线程未阻塞，仍然可以处理新来的操作。此时，如果有写操作，第一处日志就是指正在使用的 AOF 日志，Redis 会把这个操作写到它的缓冲区。这样一来，即使宕机了，这个 AOF 日志的操作仍然是齐全的，可以用于恢复。



##### AOF 重写日志

重写时，新来的写操作也回写入重写日志的缓冲区，等到拷贝数据的所有操作记录重写完成后，重写日志记录的这些最新操作也会写入新的 AOF 文件，以保证数据库最新状态的记录。此时，我们就可以用新的 AOF 文件替代旧文件了。

![img](./6b054eb1aed0734bd81ddab9a31d0be8.jpg)