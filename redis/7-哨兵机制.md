### 哨兵机制

从本质上说，哨兵就是一个运行在特定模式下的 Redis 实例，只不过它并不服务请求操作，只是完成监控、选主和通知的任务。

- 监控：判断主、从是否在线，若主不在，触发选主；
- 选主：从从库中选择合适的作为新主；
- 通知：通知其他从库新主库的信息；



#### 监控

哨兵进程在运行时，周期性地给所有的主从库发送 PING 命令，检测它们是否仍然在线运行。

- 如果从库没有在规定时间内响应哨兵的 PING 命令，哨兵就会把它标记为“下线状态”；
- 如果主库也没有在规定时间内响应哨兵的 PING 命令，哨兵就会判定主库下线，然后开始**自动切换主库**的流程

##### 主观下线

- 如果哨兵发现从库 PING 命令的响应超时了，直接判定 `主观下线` 即可；
- 如果是主库，为避免由于**集群网络压力较大、网络拥塞，或者是主库本身压力较大的情况下**出现误判导致后续 `选主` 和 `通知` 的开销，应该减少误判；



##### 哨兵集群

引入多个哨兵实例一起来判断，就可以避免单个哨兵因为自身网络状况不好，而误判主库下线的情况；

因此针对主库：当有 N 个哨兵实例时，最好要有 N/2 + 1 个实例判断主库为“主观下线”，才能最终判定主库为“客观下线”。

过程如下：

1. 任何一个实例只要自身判断主库“主观下线”后，就会给其他实例发送 is-master-down-by-addr 命令；
2. 其他实例会根据自己和主库的连接情况，做出 Y 或 N 的响应；
3. 一个哨兵获得了仲裁所需的赞成票数后，就可以标记主库为“客观下线“

此时，这个哨兵就可以再给其他哨兵发送命令，表明希望由自己来执行主从切换，并让所有其他哨兵进行投票。这个投票过程称为“**Leader 选举”**。



#### 选主

##### 选择条件

- 网络状态良好：
  - 在线；
  - 与主库断连次数超过10次（断连：如果在 down-after-milliseconds 毫秒内，主从节点都没有通过网络联系上，我们就可以认为主从节点断连了）
- 从库优先级；
- 与旧主库接近程度：从库的 slave_repl_offset 最接近 master_repl_offset
- id号小的分库；







#### pub/sub

##### 哨兵互相发现

哨兵只要和主库建立起了连接，就可以在主库上发布消息了，比如说发布它自己的连接信息（IP 和端口）。

同时，它也可以从主库上订阅消息，获得其他哨兵发布的连接信息。



##### 哨兵与从库

由哨兵向主库发送 INFO 命令来完成的：

1. 哨兵给主库发送 INFO 命令，主库接受到这个命令后，就会把从库列表返回给哨兵；
2. 哨兵就可以根据从库列表中的连接信息，和每个从库建立连接，并在这个连接上持续地对从库进行监控；



##### 哨兵与客户端

如何在客户端通过监控了解哨兵进行主从切换的过程呢？比如说，**主从切换**进行到哪一步了？这其实就是要求，客户端能够获取到哨兵集群在监控、选主、切换这个过程中发生的各种事件。

**客户端可以从哨兵订阅消息。哨兵提供的消息订阅频道有很多，不同频道包含了主从库切换过程中的不同关键事件。**

<div style="text-align: center">
    <image src="./4e9665694a9565abbce1a63cf111f725.jpg" style="width:50%" />
</div>

相关使用：

```shell
subscribe +odown   // 所有实例下线事件
psubscribe *       // 订阅所有事件
// 切换主库接受事件
switch-master <master name> <oldip> <oldport> <newip> <newport>
```

