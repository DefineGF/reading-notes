### 切片集群

切片集群，也叫分片集群，就是指启动多个 Redis 实例组成一个集群，然后按照一定的规则，把收到的数据划分成多份，每一份用一个实例来保存。

#### Redis Cluster

Redis Cluster 方案采用哈希槽（Hash Slot，接下来我会直接称之为 Slot）, 一个集群中共有16384 个哈希槽。

###### 自动映射

1. 按照 CRC16 算法计算一个 16b 的值；
2. 再用这个 16bit 值对 16384 取模，得到 0~16383 范围内的模数，每个模数代表一个相应编号的哈希槽；

在部署 Redis Cluster 方案时，可以使用 cluster create 命令创建集群，此时，Redis 会自动把这些槽平均分布在集群实例上。例如，如果集群中有 N 个实例，那么，每个实例上的槽个数为 16384/N 个。



##### 手动映射

由于每个实例所在硬件资源（内存、cpu）等，为每个实例分配相同的哈希槽并不合适。可以使用 `cluster addslots` 手动分配哈希槽。

<div style="text-align:center">
    <image src="./7d070c8b19730b308bfaabbe82c2f1ab.jpg" style="width:50%" />
</div>



注意：**在手动分配哈希槽时，需要把 16384 个槽都分配完，否则 Redis 集群无法正常工作**。



#### 定位数据

Redis 实例会把自己的哈希槽信息发给和它相连接的其它实例，来完成哈希槽分配信息的扩散。当实例之间相互连接后，每个实例就有所有哈希槽的映射关系了。

客户端收到哈希槽信息后，会把哈希槽信息缓存在本地。当客户端请求键值对时，会先计算键所对应的哈希槽，然后就可以给相应的实例发送请求了。

##### 变更

- 在集群中，实例有新增或删除，Redis 需要重新分配哈希槽；
- 为了负载均衡，Redis 需要把哈希槽在所有实例上重新分布一遍；



##### 重定向机制

客户端给一个实例发送数据读写操作时，这个实例上并没有相应的数据，客户端要再给**含有该键值对的实例**发送操作命令。

```shell
GET hello:key
(error) MOVED 13320 172.16.19.5:6379
# 这里 MOVED 表示该key所在的哈希槽为: 13320; 地址为: 172.16.19.5:6379
```



<div>
    <image src="./350abedefcdbc39d6a8a8f1874eb0809.jpg" style="width:80%" /> <br>
    <text>可以看到，由于负载均衡，Slot  2 中的数据已经从实例 2 迁移到了实例 3，但是，客户端缓存仍然记录着“Slot 2 在实例 2”的信息，所以会给实例 2 发送命令。实例 2 给客户端返回一条 MOVED 命令，把 Slot  2 的最新位置（也就是在实例 3 上），返回给客户端，客户端就会再次向实例 3 发送请求，同时还会更新本地缓存，把 Slot  2 与实例的对应关系更新过来</text>
</div>





