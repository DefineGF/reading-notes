### 日志工作原理简述

当把某列数据从0 update 到 2 时，执行过程如下：

1. 根据索引查询到要修改的数据页并更新字段；
2. 写入 redo log到磁盘；redo log 状态为 prepare；
3. 写入 binlog 到磁盘；
4. 提交事务 同时将 redo log状态 改为 commit；
5. **事务提交后，修改过的数据页可以按需写回到磁盘，这个过程可以是异步的。**



#### redo

##### redo 日志如何记录？

数据结构：

- 日志序列号（LSN）: 唯一标识每个日志条目的序号。
- 事务ID: 进行修改的事务的标识符。
- 数据页号: 被修改的数据页的标识。
- 偏移量: 数据在页中的位置。
- 修改前后的数据: 这包括足够的信息来描述数据是如何被修改的。



##### 情景1：当事务提交后redo log 状态为 commit，但是数据页落盘时中断

也就是说redo log 虽然commit，但如何确定哪些数据页没有持久化成功？

引入检查点机制：检查点保证检查点之前的所有数据都写入。也就是说当数据页持久化成功之后，会修改checkout，保证之前的所有记录都已落盘。

检查点创建：

- 基于时间间隔或由于日志文件接近满自动创建检查点；
- 大量数据写入也可能触发检查点的创建；

在创建检查点时，InnoDB 会将修改过但尚未写入硬盘的脏页（dirty pages）刷新到磁盘。