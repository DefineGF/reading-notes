### 快照

#### 快照格式

![image-20230926105542466](./image-20230926105542466.png)

- creator_trx_id ：指的是**创建该 Read View 的事务的事务 id**。
- m_ids ：指的是在创建 Read View 时，当前数据库中「活跃事务」的**事务 id 列表**，注意是一个列表，**“活跃事务”指的就是，启动了但还没提交的事务**。
- min_trx_id ：指的是在创建 Read View 时，当前数据库中「活跃事务」中事务 **id 最小的事务**，也就是 m_ids 的最小值。
- max_trx_id ：这个并不是 m_ids 的最大值，而是**创建 Read View 时当前数据库中应该给下一个事务的 id 值**，也就是全局事务中最大的事务 id 值 + 1；

#### 行记录格式

聚簇索引记录中都包含下面两个隐藏列：

- trx_id，当一个事务对某条聚簇索引记录进行改动时，就会**把该事务的事务 id 记录在 trx_id 隐藏列里**；
- roll_pointer，每次对某条聚簇索引记录进行改动时，都会把旧版本的记录写入到 undo 日志中，然后**这个隐藏列是个指针，指向每一个旧版本记录**，于是就可以通过它找到修改前的记录



#### 读提交

**读提交隔离级别是在每次读取数据时，都会生成一个新的 Read View**。



#### 可重复读

**可重复读隔离级别是启动事务时生成一个 Read View，然后整个事务期间都在用这个 Read View**。







### 日志

- **undo log（回滚日志）**：是 Innodb 存储引擎层生成的日志，实现了事务中的**原子性**

  > 原子性要求一个事务中的所有操作要么全部执行成功，要么全部回滚，不允许出现部分执行的情况。Undo日志是数据库中用于实现事务回滚的关键机制之一。
  >
  > 当一个事务开始执行时，数据库会将事务所做的修改操作记录到Undo日志中，包括对数据的更新、插入和删除等操作。Undo日志中记录了事务所修改的数据的旧值。
  >
  > 在事务执行过程中，如果发生了回滚操作，数据库可以利用Undo日志中的信息将数据恢复到事务开始之前的状态。通过回滚Undo日志中记录的操作，可以确保事务的原子性，即使在事务执行过程中发生了错误或异常情况。



##### redo 和 undo

- redo log 记录了此次事务「**完成后**」的数据状态，记录的是更新**之后**的值；
- undo log 记录了此次事务「**开始前**」的数据状态，记录的是更新**之前**的值；



事务提交之前发生了崩溃，重启后会通过 undo log 回滚事务，事务提交之后发生了崩溃，重启后会通过 redo log 恢复事务。



#### undo

##### 作用

- 实现事务回滚，保障事务的原子性

- 实现事务回滚，保障事务的原子性

  > - 「读提交」隔离级别是在每个 select 都会生成一个新的 Read View，也意味着，事务期间的多次读取同一条数据，前后两次读的数据可能会出现不一致，因为可能这期间另外一个事务修改了该记录，并提交了事务。
  > - 「可重复读」隔离级别是启动事务时生成一个 Read View，然后整个事务期间都在用这个 Read View，这样就保证了在事务期间读到的数据都是事务启动前的记录。

##### 回滚时机

1. 显式回滚：当应用程序或用户明确执行回滚操作时，事务会被回滚。这可以通过执行ROLLBACK语句来实现。
2. 事务执行过程中的错误：如果在事务执行过程中发生了错误，例如违反了约束条件、死锁等，数据库管理系统会自动触发回滚操作，将事务的所有修改操作撤销，恢复到事务开始之前的状态。
3. 事务的隔离级别冲突：如果事务与其他事务之间存在隔离级别冲突，例如读取到了被其他事务修改但未提交的数据（脏读）、发生了不可重复读或幻读等情况，数据库管理系统可以根据隔离级别设置自动触发回滚操作，确保数据的一致性。
4. 手动处理异常：在编程中，可以通过捕获异常并根据业务逻辑决定是否回滚事务。如果发生了意外情况或错误，可以选择回滚事务以保持数据的一致性。



##### 过程

- 在**插入**一条记录时，要把这条记录的主键值记下来，这样之后回滚时只需要把这个主键值对应的记录**删掉**就好了；
- 在**删除**一条记录时，要把这条记录中的内容都记下来，这样之后回滚时再把由这些内容组成的记录**插入**到表中就好了；
- 在**更新**一条记录时，要把被更新的列的旧值记下来，这样之后回滚时再把这些列**更新为旧值**就好了



#### redo

redo log 是**循环写**，日志空间大小是固定，全部写满就从头开始，保存未被刷入磁盘的脏页日志。

##### 刷盘

- MySQL 正常关闭时；
- 当 redo log buffer 中记录的写入量大于 redo log buffer 内存空间的一半时，会触发落盘；
- InnoDB 的后台线程每隔 1 秒，将 redo log buffer 持久化到磁盘。
- 每次事务提交时都将缓存在 redo log buffer 里的 redo log 直接持久化到磁盘